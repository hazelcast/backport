name: Backport
description: A workflow that allows Backporting PRs via labels etc

on:
  workflow_call:
    inputs:
      BACKPORT_PREFIX:
        description: The prefix to use to identify backport labels - e.g. with a prefix of "Backport to", "Backport to 1.2.3" would backport to "1.2.3" target branch
        required: true
        type: string
      BACKPORT_OPTIONS:
        description: Additional options to pass through to the tool
        required: false
        type: string
    secrets:
      GH_TOKEN:
        required: true

jobs:
  get-current-pr:
    name: Get current PR
    runs-on: ubuntu-slim
    outputs:
      number: ${{ steps.pr.outputs.number }}
      # Extract as much metadata as possible to avoid querying later
      labels: ${{ steps.pr.outputs.pr_labels }}
      # The action returns a SHA even for unmerged PRs, additional filtering required
      merge_commit_sha: ${{ steps.pr.outputs.pr_found == 'true' && fromJSON(steps.pr.outputs.pr).merged_at != null && fromJSON(steps.pr.outputs.pr).merge_commit_sha || '' }}
    steps:
      - id: pr
        uses: 8BitJonny/gh-get-current-pr@4056877062a1f3b624d5d4c2bedefa9cf51435c9 # v4.0.0

  parse-pr:
    if: needs.get-current-pr.outputs.merge_commit_sha != ''
    name: 'Parse PR #${{ needs.get-current-pr.outputs.number }}'
    runs-on: ubuntu-slim
    needs:
      - get-current-pr
    concurrency:
      group: ${{ github.workflow }}-${{ github.repository }}-pr-${{ needs.get-current-pr.outputs.number }}
    outputs:
      backport-branches: ${{ steps.parse-labels.outputs.backport_branches }}
    steps:
      - name: Parsing labels for backports
        id: parse-labels
        run: |
          set -o errexit -o nounset -o pipefail ${RUNNER_DEBUG:+-x}
          source /dev/stdin <<< "$(curl --silent https://raw.githubusercontent.com/hazelcast/github-actions-common-scripts/main/logging.functions.sh)"

          backport_labels=()
          backport_branches=()

          IFS=, read -ra labels <<< "${{ needs.get-current-pr.outputs.labels }}"

          for label in "${labels[@]}"; do
            if [[ ${label} == "${BACKPORT_PREFIX}"* ]]; then
              backport_labels+=("${label}")

              branch=${label#"${BACKPORT_PREFIX} "}
              echodebug "Extracted \"${branch}\" branch from \"${label}\""
              backport_branches+=("${branch}")
            else
              echodebug "Skipped label \"${label}\" (not a backport)"
            fi
          done

          function array_to_json() {
            jq --null-input --compact-output '$ARGS.positional' --args "$@"
          }

          json=$(array_to_json "${backport_labels[@]}")
          echo "backport_labels=${json})" >> ${GITHUB_OUTPUT}

          json=$(array_to_json "${backport_branches[@]}")
          echo "backport_branches=${json})" >> ${GITHUB_OUTPUT}
        env:
          BACKPORT_PREFIX: ${{ inputs.BACKPORT_PREFIX }}

      - name: Remove backport labels (${{ steps.parse-labels.outputs.backport_labels }})
        run: |
          set -o errexit -o nounset -o pipefail ${RUNNER_DEBUG:+-x}

          mapfile -t labels < <(jq -r '.[]' <<< '${{ steps.parse-labels.outputs.backport_labels }}')

          for backport_label in "${labels[@]}"; do
            gh pr edit "${{ needs.get-current-pr.outputs.number }}" \
              --repo ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} \
              --remove-label "${backport_label}"
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  backport:
    name: Backport to "${{ matrix.branch }}"
    if: needs.parse-pr.outputs.backport-branches != '[]'
    runs-on: ubuntu-slim
    needs:
      - get-current-pr
      - parse-pr
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJSON(needs.parse-pr.outputs.backport-branches) }}
    steps:
      - name: 'Checkout `${{ github.repository }}`'
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          token: ${{ secrets.GH_TOKEN }}

      - name: 'Checkout `hazelcast/backport`'
        uses: actions/checkout@v4
        with:
          # TODO should not be hardcoded
          repository: hazelcast/backport
          path: backport

      - name: Backport
        run: |
          set -o errexit -o nounset -o pipefail ${RUNNER_DEBUG:+-x}
          source /dev/stdin <<< "$(curl --silent https://raw.githubusercontent.com/hazelcast/github-actions-common-scripts/main/logging.functions.sh)"

          # Git metadata is required but not available out-of-the-box, inherit from the action
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          # Add "upstream" remote as checkout action doesn't include by default
          git remote add upstream "${{ github.event.repository.clone_url }}"
          git fetch --all

          backport_target_branch=upstream/"${{ matrix.branch }}"
          echodebug "Running backport script to backport "${{ needs.get-current-pr.outputs.merge_commit_sha }}" into \"${backport_target_branch}\""

          backport/backport \
            "${{ needs.get-current-pr.outputs.merge_commit_sha }}" \
            "${backport_target_branch}" \
            --non-interactive \
            ${{ inputs.BACKPORT_OPTIONS }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Report success
        run: |
          set -o errexit -o nounset -o pipefail ${RUNNER_DEBUG:+-x}

          gh pr comment "${{ needs.get-current-pr.outputs.number }}" \
            --repo ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} \
            --body "ðŸ‘ Created $(gh pr view --json url --jq .url) to backport into [\`${{ matrix.branch }}\`](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/${{ matrix.branch }})."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Report errors
        if: failure()
        run: |
          set -o errexit -o nounset -o pipefail ${RUNNER_DEBUG:+-x}
          source /dev/stdin <<< "$(curl --silent https://raw.githubusercontent.com/hazelcast/github-actions-common-scripts/main/logging.functions.sh)"

          echoerr "Error running action"
          echo_group "Troubleshooting Information:"
          echo "- Repositories' GitHub action configuration - ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/settings/actions"
          echo "- Action does not run when triggered from a forked repo's PR?"
          echo "    Enable \"Run workflows from fork pull requests\""
          echo "- Backport fails with \"GraphQL: GitHub Actions is not permitted to create or approve pull requests (createPullRequest)\"?"
          echo "    Either:"
          echo "        * Enable \"Allow GitHub Actions to create and approve pull requests\""
          echo "        * Use a different \"GH_TOKEN\" with appropriate permissions"
          echo "- \"GraphQL: Resource not accessible by integration (addComment)\"?"
          echo "    Either:"
          echo "        * Enable \"Send write tokens to workflows from fork pull requests\""
          echo "        * Use a different \"GH_TOKEN\" with appropriate permissions"
          echo_group_end
          gh pr comment "${{ needs.get-current-pr.outputs.number }}" \
            --repo ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} \
            --body "âŒ [Failed to backport](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}), change must be manually backported."
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
